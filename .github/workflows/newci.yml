name: CI

on:
  push:
  pull_request:

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.10"]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Download spaCy model & NLTK data
        run: |
          python -m spacy download en_core_web_sm || true
          python - <<'PY'
          import nltk
          for r in ("punkt","stopwords","wordnet","omw-1.4"):
              try:
                  nltk.download(r)
              except:
                  pass
          PY

      - name: Smoke test (imports)
        run: | 
          python - <<'PY'
          import sys
          from importlib import import_module
          pkgs = ["pandas","numpy","nltk","spacy","sklearn","matplotlib"]
          missing = []
          for p in pkgs:
              try:
                  import_module(p)
              except Exception:
                  missing.append(p)
          if missing:
              print("Missing packages:", missing)
              sys.exit(1)
          print("Smoke imports OK")
          PY

      - name: Run tests (if present)
        run: |
          if command -v pytest >/dev/null 2>&1; then
            if [ -d tests ] || ls test_*.py *_test.py >/dev/null 2>&1; then
              pytest -q
            else
              echo "No pytest tests found; skipping"
            fi
          else
            echo "pytest not installed; skipping"
          fi
